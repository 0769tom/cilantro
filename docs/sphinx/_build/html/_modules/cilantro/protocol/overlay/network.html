
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cilantro.protocol.overlay.network &#8212; cilantro 9000 BC documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cilantro.protocol.overlay.network</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Package for interacting on the network at a high level.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">zmq</span>

<span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">select</span><span class="o">,</span> <span class="nn">struct</span>

<span class="kn">from</span> <span class="nn">nacl.signing</span> <span class="k">import</span> <span class="n">VerifyKey</span>
<span class="kn">from</span> <span class="nn">cilantro.logger</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.structures</span> <span class="k">import</span> <span class="n">Bidict</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.overlay.protocol</span> <span class="k">import</span> <span class="n">KademliaProtocol</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.overlay.utils</span> <span class="k">import</span> <span class="n">digest</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.overlay.node</span> <span class="k">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.overlay.crawling</span> <span class="k">import</span> <span class="n">ValueSpiderCrawl</span><span class="p">,</span> <span class="n">NodeSpiderCrawl</span>
<span class="kn">from</span> <span class="nn">cilantro.protocol.overlay.ironhouse</span> <span class="k">import</span> <span class="n">Ironhouse</span>

<span class="k">try</span><span class="p">:</span> <span class="n">poll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">epoll</span>
<span class="k">except</span><span class="p">:</span> <span class="n">poll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span>
<span class="k">try</span><span class="p">:</span> <span class="n">POLLIN</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span>
<span class="k">except</span><span class="p">:</span> <span class="n">POLLIN</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">HEARTBEAT_PORT_OFFSET</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">AUTH_PORT_OFFSET</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="Network"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network">[docs]</a><span class="k">class</span> <span class="nc">Network</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    High level view of a node instance.  This is the object that should be</span>
<span class="sd">    created to start listening as an active node on the network.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">protocol_class</span> <span class="o">=</span> <span class="n">KademliaProtocol</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">discovery_mode</span><span class="o">=</span><span class="s1">&#39;neighborhood&#39;</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_peers</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">network_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">public_ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a server instance.  This will start listening on the given port.</span>

<span class="sd">        Args:</span>
<span class="sd">            ksize (int): The k parameter from the paper</span>
<span class="sd">            alpha (int): The alpha parameter from the paper</span>
<span class="sd">            node_id: The id for this node on the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="k">if</span> <span class="n">loop</span> <span class="k">else</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vkcache</span> <span class="o">=</span> <span class="n">Bidict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorized_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span> <span class="o">=</span> <span class="n">ksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_state_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_peers</span> <span class="o">=</span> <span class="n">max_peers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_port</span> <span class="o">=</span> <span class="n">network_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_port</span><span class="o">+</span><span class="n">HEARTBEAT_PORT_OFFSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span> <span class="o">=</span> <span class="n">Ironhouse</span><span class="p">(</span><span class="n">auth_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network_port</span><span class="o">+</span><span class="n">AUTH_PORT_OFFSET</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">node_id</span><span class="o">=</span><span class="n">digest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">vk</span><span class="p">),</span>
            <span class="n">public_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">public_ip</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HOST_IP&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">),</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network_port</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_stethoscope</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">setup_secure_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveStateRegularly</span><span class="p">(</span><span class="s1">&#39;state.tmp&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Network.authenticate"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.authenticate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bootstrappableNeighbors</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">public_key</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Node </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1"> is already a neighbor&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">authorized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="o">+</span><span class="n">AUTH_PORT_OFFSET</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">authorized</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1"> is authorized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">authorized</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;!UNAUTHORIZED! </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">authorized</span></div>

<div class="viewcode-block" id="Network.setup_stethoscope"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.setup_stethoscope">[docs]</a>    <span class="k">def</span> <span class="nf">setup_stethoscope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_peers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stethoscope</span><span class="p">())</span></div>

<div class="viewcode-block" id="Network.stethoscope"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.stethoscope">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">stethoscope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">poll</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Listening to heartbeats on </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_port</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fileno</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span><span class="p">):</span>
                        <span class="n">conn</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">fileno</span><span class="p">]</span>
                        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="o">+</span><span class="n">HEARTBEAT_PORT_OFFSET</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;reconnecting </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_port</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
                            <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                                <span class="mi">54</span><span class="p">,</span> <span class="c1"># reset by peer</span>
                            <span class="p">]:</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">) disconnected from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>
                                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">fileno</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vkcache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">):</span>
                                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vkcache</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">removeContact</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">fileno</span><span class="p">)</span>
                                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network shutting down gracefully.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Network.connect_to_neighbor"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.connect_to_neighbor">[docs]</a>    <span class="k">def</span> <span class="nf">connect_to_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">create_from_public_key</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">reconfigure_curve</span><span class="p">()</span>

        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="o">+</span><span class="n">HEARTBEAT_PORT_OFFSET</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">POLLIN</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[CLIENT SIDE] Client (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">) connected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">conn</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()]</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Network.lookup_ip_in_cache"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.lookup_ip_in_cache">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_ip_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vk</span><span class="p">):</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vkcache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ip</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found ip </span><span class="si">{}</span><span class="s1"> in cache&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ip</span></div>

<div class="viewcode-block" id="Network.lookup_ip"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.lookup_ip">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">lookup_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_key</span><span class="p">):</span>
        <span class="n">cache_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_ip_in_cache</span><span class="p">(</span><span class="n">node_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_node</span><span class="p">:</span> <span class="k">return</span> <span class="n">cache_node</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="n">digest</span><span class="p">(</span><span class="n">node_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

        <span class="n">nearest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">findNeighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="n">spider</span> <span class="o">=</span> <span class="n">NodeSpiderCrawl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">nearest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting lookup for node_key </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_key</span><span class="p">))</span>
        <span class="n">res_node</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">res_node</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span> <span class="n">res_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> resolves to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_key</span><span class="p">,</span> <span class="n">res_node</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res_node</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vkcache</span><span class="p">[</span><span class="n">node_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_node</span><span class="o">.</span><span class="n">ip</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">vk2pk</span><span class="p">(</span><span class="n">node_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res_node</span></div>

<div class="viewcode-block" id="Network.stop"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_loop</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_state_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_state_loop</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fileno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">fileno</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">fileno</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Already unregistered&#39;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Closed a previously opened connection&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ironhouse</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stehoscope is already unregistered&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span><span class="c1">#log.debug(&#39;Not epoll object, no need to close.&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stethoscope_future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_create_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Network.listen"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start listening on the given port.</span>

<span class="sd">        Provide interface=&quot;::&quot; to accept ipv6 address</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_port</span>
        <span class="n">listen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_datagram_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_protocol</span><span class="p">,</span>
                                               <span class="n">local_addr</span><span class="o">=</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Listening to kade network on </span><span class="si">%s</span><span class="s2">:</span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">interface</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">listen</span><span class="p">)</span>
        <span class="c1"># finally, schedule refreshing table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_table</span><span class="p">()</span></div>

<div class="viewcode-block" id="Network.refresh_table"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.refresh_table">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_refresh_table</span><span class="p">())</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_refresh_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh buckets that haven&#39;t had any lookups in the last hour</span>
<span class="sd">        (per section 2.3 of the paper).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Refreshing routing table&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">getRefreshIDs</span><span class="p">():</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="p">)</span>
            <span class="n">nearest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">findNeighbors</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">spider</span> <span class="o">=</span> <span class="n">NodeSpiderCrawl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">nearest</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spider</span><span class="o">.</span><span class="n">find</span><span class="p">())</span>

        <span class="c1"># do our crawling</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span>

<div class="viewcode-block" id="Network.bootstrappableNeighbors"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.bootstrappableNeighbors">[docs]</a>    <span class="k">def</span> <span class="nf">bootstrappableNeighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a :class:`list` of (ip, port) :class:`tuple` pairs suitable for</span>
<span class="sd">        use as an argument to the bootstrap method.</span>

<span class="sd">        The server should have been bootstrapped</span>
<span class="sd">        already - this is just a utility for getting some neighbors and then</span>
<span class="sd">        storing them if this server is going down for a while.  When it comes</span>
<span class="sd">        back up, the list of nodes can be used to bootstrap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">findNeighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">]</span></div>

<div class="viewcode-block" id="Network.bootstrap"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.bootstrap">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bootstrap the server by connecting to other known nodes in the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            addrs: A `list` of (ip, port) `tuple` pairs.  Note that only IP</span>
<span class="sd">                   addresses are acceptable - hostnames will cause an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to bootstrap node with </span><span class="si">%i</span><span class="s2"> initial contacts&quot;</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="n">addrs</span><span class="p">))</span>
        <span class="n">cos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_node</span><span class="p">,</span> <span class="n">addrs</span><span class="p">))</span>
        <span class="n">gathered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">cos</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">gathered</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to find/authenticate with any nodes in the network&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">spider</span> <span class="o">=</span> <span class="n">NodeSpiderCrawl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spider</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Network.bootstrap_node"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.bootstrap_node">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">bootstrap_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">node_id</span><span class="p">,</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">public_key</span><span class="o">=</span><span class="n">public_key</span><span class="p">)</span>
            <span class="n">authorized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authorized</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Network.saveState"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.saveState">[docs]</a>    <span class="k">def</span> <span class="nf">saveState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the state of this node (the alpha/ksize/id/immediate neighbors)</span>
<span class="sd">        to a cache file with the given fname.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving state to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ksize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ksize</span><span class="p">,</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;neighbors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bootstrappableNeighbors</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No known neighbors, so not writing to cache.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Network.loadState"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.loadState">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">loadState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the state of this node (the alpha/ksize/id/immediate neighbors)</span>
<span class="sd">        from a cache file with the given fname.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading state from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Network.saveStateRegularly"><a class="viewcode-back" href="../../../../cilantro.protocol.overlay.html#cilantro.protocol.overlay.network.Network.saveStateRegularly">[docs]</a>    <span class="k">def</span> <span class="nf">saveStateRegularly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the state of node with a given regularity to the given</span>
<span class="sd">        filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname: File name to save retularly to</span>
<span class="sd">            frequency: Frequency in seconds that the state should be saved.</span>
<span class="sd">                        By default, 10 minutes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveState</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_state_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">saveStateRegularly</span><span class="p">,</span>
                                               <span class="n">fname</span><span class="p">,</span>
                                               <span class="n">frequency</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../cilantro.html">cilantro</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, team@lamden.io.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>